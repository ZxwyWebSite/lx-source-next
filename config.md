## LX-Source/配置文档 `v251004`

<!-- ### **——**

全部平台刷新登录频率改为每天一次，目前仍有较严重的时段特征。 -->

### ✦ **`Main`** ✦

**主要配置**

- **`Debug`:** 调试模式，开启后输出更详细日志。

- **`Listen`:** 监听地址，支持使用表达式。

  示例：（仅供娱乐，实际也用不到那么些地址）

  1. 分隔 `expr1;expr2` 作为独立表达式解析
  2. 范围 `:1011-1020` 包含 [1011, ..., 1020]
  3. 端口 `:1011,1101` 没有去重注意
  4. 地址 `127.0.0.1:1011`

- **`Proxy`:** 是否存在前置代理。

  例如 Nginx 等网关程序，此功能确保获取到正确的客户端 IP 以及防止伪造 IP。

- **`RealIP`:** 真实 IP 请求头。

  默认 `X-Forwarded-For` 与 `X-Real-IP`，可自定义，以 `|` 分隔。

- **`Cors`:** 添加跨域响应头。

  便于浏览器跨域调用。

- **`LogFile`:** 文件日志

  注意：相对运行目录

- **`Console`:** 控制台输出

  关闭后不在控制台输出日志，仅记录到文件，可在部分情况下提升 IO 性能

### ✦ **`Apis`** ✦

**接口设置**

- **`WebLog`:** 网页端日志查看（测试版）

  地址：`{}/test/sse`

  注意：仅供测试，没有鉴权，谨慎开启。

### ✦ **`Auth`** ✦

**访问控制**

- **✧ `BanList` ✧**

  **黑白名单**

  - **`Enable`:** 启用此功能

  - **`Strict`:** 严格模式

  - **`White`:** 白名单

    此为真正的白名单，其中用户不受速率限制，但仍需 key 验证

    可添加：

    **单 IP:** `192.168.10.22`

    **网段:** `192.168.10.0/24`

    **文件:** `#data/ip/local.txt` (换行分隔，相对运行目录)

  - **`Black`:** 黑名单

    为节省空间，正常情况下：阻止黑名单用户，放行其它普通用户

    严格模式下：放行黑名单普通用户，阻止其它未过白用户

- **✧ `RateLimit` ✧**

  **速率限制**

  - **`Enable`:** 启用此功能

  - **`Block`:** 检测区间

    在指定秒数内进行检测，过期刷新

  - **`Globle`:** 全局限制

    所有用户总请求数限制，支持填 0 禁用

  - **`Single`:** 单 IP 限制

    单个 IP 每分区内允许的请求数

  - **`BanNum`:** 容忍次数

    超出几次后开始延长封禁时间

  - **`BanTim`:** 封禁时间

    每次延长的分区时间

- **✧ `ApiPass` ✧**

  **接口密钥**

  - **`Enable`:** 启用此功能

  - **`Auto`:** 自动填入脚本（仅供测试）

    获取脚本时自动填入密钥，适用于

  - **`Value`:** 密钥值

    格式任意，留空随机生成 11 位 `Base64URLRaw(RandomBytes(8))`

- **✧ `UniPass` ✧**

  **独立密钥，可用于关联用户**

  - **`Enable`:** 启用此功能

  - **`Pool`:** 密钥池

    格式：`'密钥'='用户标识'`

### ✦ **`Srcs`** ✦

**解析源**

- **✧ `Bn` ✧**

  **内置源 builtin**

  ※ 请合理使用，切勿过度依赖！

  ... 搜集自网络，无固定配置，请以实际版本为准。

- **✧ `Wy` ✧**

  **小芸源**

  - **`Enable`:** 启用来源

  - **`Prefetch`:** 条件获取 (`v1.1.9+`)

    获取音频链接前先查询详情，根据访问权限决定使用游客还是会员账号

    由于需要调用两次接口，可能会导致处理降速，默认关闭

    可降低因频繁调用接口而导致封号的概率？

    海外用户记得在下方设置游客伪装 IP

  - **`FakeIP`:** 游客账号伪装 IP

  - **[]`Group`:** 分组 ¶

    由于此来源特殊的分配模式，引入的分组中间层

  - **`Enable`:** 启用分组

    此处若关闭会跳过整个分组的载入

  <!-- - **`Mode`:** 分配模式

    你猜？ -->

  - **[]`Node`:** 账号池 ¶

  - **`Enable`:** 启用账号

    此处关闭也可正常添加后台任务，仅不用作解析

  - **`Cookie`:** 账号凭据

    内部使用对象化表示，开启刷新登录或每日签到等功能会自动将补全的信息回写到配置文件

    支持使用特殊参数 `realIP` 设置伪装 IP

  - **`Refresh`:** 刷新登录

    保持登录状态，防止凭据失效

    约每 7 天更换一次 `MUSIC_U` 与 `refreshToken`，旧凭据仍可使用

  - **`DailyTask`:** 每日签到

    签到领积分，我也不知道有什么用 (⊙_⊙)？

  - **`DailyListen`:** 听歌打卡

    ☢ 高能警告 ☢ 使用此功能可能因违反用户协议而被封禁账号

    使用日推数据进行听歌打卡

    若获取不到数据请到 隐私设置 中打开 个性化服务 功能

- **✧ `Mg` ✧**

  **小蜜源**

  ※ 不支持海外使用 ※

  - **`Enable`:** 启用来源

    同步源脚本激活状态

- **✧ `Kw` ✧**

  **小蜗源**

  - **`Enable`:** 启用来源

    同步源脚本激活状态

  - **`Source`:** 白名单包名

    留空默认，高级用户可自行修改

  - **`FakeIP`:** 伪装 IP

    适用于海外用户，建议使用 [ISP 网段](https://github.com/metowolf/iplist?tab=readme-ov-file#%E8%BF%90%E8%90%A5%E5%95%86-ip-%E6%AE%B5)

- **✧ `Kg` ✧**

  **小枸源**

  - **`Enable`:** 启用来源

  - **`FakeIP`:** 伪装 IP

    适用于海外用户，建议使用 ISP 网段

  - **[]`Node`:** 账号池 ¶

  - **`Enable`:** 启用账号

    此处关闭也可正常添加后台任务，仅不用作解析

  - **`Plat`:** 平台信息

    各平台间账号数据不互通

    完整支持：官方安卓、Lite 概念版

    据说官方安卓版风控严重，需要共享的注意一下

  - **`UserId`:** 账号 ID

    ※ 游客填 0

  - **`Token`:** 账号 Token

  - **`Mid`:** 设备 mid（可选）

  - **`Dfid`:** 设备 dfid（可选）

  - **`Device`:** 设备型号（可选）

  - **`Refresh`:** 刷新登录

    延长 Token 过期时间，大概 30 天

    内部设备信息实现不完整，会导致掉登录，请使用 [MakcRe/KuGouMusicApi](https://github.com/MakcRe/KuGouMusicApi) 项目登录或手动抓包。

  - **`LiteSignin`:** 概念版自动签到

    旧版实现

- **✧ `Tx` ✧**

  **小秋源**

  ※ 为避免被绿尸寒警告，已移除内置实现 ※<!-- ~~（没时间更新）~~ -->

  - **`Enable`:** 启用来源

    同步源脚本激活状态

- **✧ `Lx` ✧**

  **小洛源**

  可对接旧版 [lx-music-api-server](https://github.com/MeoProject/lx-music-api-server) 实现

  与 LX-Source 任意版本（新版需加 `{addr}/api/v0/`）

  - **`Enable`:** 启用来源

  - **[]`Node`:** 账号池 ¶

  - **`Enable`:** 启用账号

  - **[]`Plat`:** 启用平台

    支持 `wy` / `kg` / `tx`

  - **`Addr`:** 接口地址

  - **`Pass`:** 接口密钥

  - **`UA`:** 用户标识 `User-Agent`

  - **`Head`:** 密钥标头

    默认 `X-Request-Key` 保证兼容，若使用其它标头可修改

### ✦ **`Lxcs`** ✦

[**自定义脚本信息**](https://lxmusic.toside.cn/mobile/custom-source#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%BA%90%E4%BF%A1%E6%81%AF)

- **`Name`:** 源的名字

  建议 24 个字符以内

- **`Desc`:** 源的描述

  建议 36 个字符以内，可不填

- **`Vers`:** 源的版本

  可不填（暂时只读）

- **`Auth`:** 源的作者

  可不填

- **`Home`:** 源的主页

  可不填

### ✦ **`Data`** ✦

**数据存储（缓存）**

- **`Mode`:** 缓存模式

  `[0]` none: 禁用

  `[1]` safe: 安全模式

  等待缓存完成后返回文件链接，可能导致竞态问题

  `[2]` fast: 极速模式

  首次直接返回原链接，后台缓存后更新，若平台存在跟踪参数可能增大封号概率

- **`Type`:** 缓存类型

  `[0]` local: 本地缓存

* **✧ `Rule` ✧**

  **缓存规则**

  - **`ExcP`:** 排除平台

    开启后不缓存下列平台

  - **`Plat`:** 缓存平台

    可选 `wy` / `mg` / `kw` / `kg` / `tx`

  - **`ExcQ`:** 排除音质

    开启后不缓存下列音质

  - **`Qual`:** 缓存音质

    可选 `128k` / `192k` / `320k` / `flac` / `flac24bit` / ... / `temp`(试听) / `orig`(电台/云盘)

- **✧ `Local` ✧**

  **本地缓存**

  - **`Path`:** 保存路径

    （相对为运行目录，绝对目录不变）

  - **`Bind`:** 访问地址

    如需为缓存分流或使用其它域名，可填写对应 URL（末尾不带斜杠）

  - **`Expi`:** 临时链过期时间，单位秒

  - **`Sign`:** 临时链签名密钥，值随意

  - **`Acip`:** 限制访问 IP

    开启后会将用户 IP 加入到签名中

    可有效限制二次分发？

  - **`Dyna`:** 临时外链

    开启后验证签名

    防止根据文件路径直接查询？

### ✦ **`Memo`** ✦

**内存缓存**

※ 新版缓存暂不支持持久化，重载即丢失全部数据

- **`Shards`:** 自定义分片大小

  默认为 1024，大小越大，锁强度越小，并发性能越高，但内存占用也会越高，请尽量选择适合自己业务场景的大小

  —— [go-cache](https://github.com/xhofe/go-cache/blob/b1a71927bc21605b39a73637283b62e9c1af1af3/option.go#L30)

### ✦ **`Errs`** ✦

**错误提示**

- **`Expi`:** 过期时间

  单位秒。建议设置较短时间以使客户端自动刷新

- **`ErrMp3`:** 自定义音频地址

<!-- **:**  -->
